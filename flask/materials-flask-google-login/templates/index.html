<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dante Memories!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/main.css') }}">
    <link rel="icon" type="image/jpg" href="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Photos_icon_%282020%29.svg"/>
</head>
<body>
<div class="header-container">
    <h1>On This Day - {{ date.strftime('%B %d') }}</h1>
    <button class="calendar-btn" id="calendarBtn" onclick="openCalendar()">
        ðŸ“… Choose Different Date
    </button>
</div>

<p>Memories from {{ date.strftime('%B %d') }} in previous years</p>
<p>Found {{ media['images']|length }} images and {{ media['videos']|length }} videos from {{ years_found|length }} different years</p>

<!-- Calendar Modal -->
<div id="calendarModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Select a Date</h2>
            <span class="close" onclick="closeCalendar()">&times;</span>
        </div>
        <div class="calendar-container">
            <div class="calendar-navigation">
                <button onclick="previousMonth()">&lt;</button>
                <span id="currentMonth"></span>
                <button onclick="nextMonth()">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar days will be generated by JavaScript -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeCalendar()">Cancel</button>
            <button class="btn-today" onclick="selectToday()">Today</button>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loader"></div>
    <p>Loading photos...</p>
</div>

<div id="mediaContainer">
    {% if years_found %}
        {% for year in years_found|sort|reverse %}
        <div class="year-section">
            <h2>{{ year }} ({{ date.year - year }} years ago)</h2>
            <div class="media-grid">
                {% for image in media['images'] %}
                    {% if image.year == year %}
                    <img src="/{{ image.path }}?w=400&q=75" alt="Image from {{ year }}" onclick="toggleFullscreen('/{{ image.path }}')">
                    {% endif %}
                {% endfor %}
                {% for video in media['videos'] %}
                    {% if video.year == year %}
                    <video id="video{{ year }}_{{ loop.index }}" controls onclick="playVideo('video{{ year }}_{{ loop.index }}')">
                        <source src="/{{ video.path }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="year-section">
            <h2>No memories found for this day</h2>
            <p>No photos or videos found for {{ date.strftime('%B %d') }} in previous years.</p>
        </div>
    {% endif %}
</div>

<!-- Fullscreen container -->
<div id="fullscreenDiv" class="fullscreen" onclick="toggleFullscreen()">
    <img src="" alt="Full Screen Image">
</div>

<script>
    let currentDate = new Date();
    let selectedDate = null;

    // Calendar functions
    function openCalendar() {
        document.getElementById('calendarModal').style.display = 'block';
        generateCalendar();
    }

    function closeCalendar() {
        document.getElementById('calendarModal').style.display = 'none';
    }

    function generateCalendar() {
        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"];
        
        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
        
        document.getElementById('currentMonth').textContent = 
            monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
        
        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '';
        
        // Add day headers
        const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayHeaders.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            calendarGrid.appendChild(emptyDay);
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            dayElement.onclick = () => selectDate(day);
            
            // Highlight today
            const today = new Date();
            if (currentDate.getFullYear() === today.getFullYear() && 
                currentDate.getMonth() === today.getMonth() && 
                day === today.getDate()) {
                dayElement.classList.add('today');
            }
            
            calendarGrid.appendChild(dayElement);
        }
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateCalendar();
    }

    function selectDate(day) {
        const selectedDateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        const dateString = selectedDateObj.toISOString().split('T')[0];
        
        closeCalendar();
        loadPhotosForDate(dateString);
    }

    function selectToday() {
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        
        closeCalendar();
        loadPhotosForDate(dateString);
    }

    function loadPhotosForDate(dateString) {
        // Show loading overlay
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        // Update URL without page reload
        window.history.pushState({}, '', '/date/' + dateString);
        
        // Fetch photos for the selected date
        fetch('/get_photos/' + dateString)
            .then(response => response.json())
            .then(data => {
                updatePhotosDisplay(data);
                document.getElementById('loadingOverlay').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Error loading photos for selected date');
            });
    }

    function updatePhotosDisplay(data) {
        // Update header
        const headerDate = new Date(data.date);
        document.querySelector('h1').textContent = 'On This Day - ' + 
            headerDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        
        // Update info paragraph
        document.querySelector('p').textContent = 
            'Memories from ' + headerDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }) + 
            ' in previous years';
        
        // Update count paragraph
        document.querySelectorAll('p')[1].textContent = 
            'Found ' + data.media.images.length + ' images and ' + data.media.videos.length + 
            ' videos from ' + data.years_found.length + ' different years';
        
        // Update media container
        const mediaContainer = document.getElementById('mediaContainer');
        
        if (data.years_found.length > 0) {
            let html = '';
            const sortedYears = data.years_found.sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const currentYear = new Date().getFullYear();
                const yearsAgo = currentYear - year;
                
                html += `<div class="year-section">
                    <h2>${year} (${yearsAgo} years ago)</h2>
                    <div class="media-grid">`;
                
                // Add images for this year
                data.media.images.forEach(image => {
                    if (image.year === year) {
                        html += `<img src="/${image.path}?w=400&q=75" alt="Image from ${year}" onclick="toggleFullscreen('/${image.path}')">`;
                    }
                });
                
                // Add videos for this year
                data.media.videos.forEach((video, index) => {
                    if (video.year === year) {
                        const videoId = `video${year}_${index}`;
                        html += `<video id="${videoId}" controls onclick="playVideo('${videoId}')">
                            <source src="/${video.path}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>`;
                    }
                });
                
                html += `</div></div>`;
            });
            
            mediaContainer.innerHTML = html;
        } else {
            mediaContainer.innerHTML = `
                <div class="year-section">
                    <h2>No memories found for this day</h2>
                    <p>No photos or videos found for ${data.formatted_date} in previous years.</p>
                </div>`;
        }
    }

    // Existing functions
    function playVideo(videoId) {
        var video = document.getElementById(videoId);

        // Check if the video is already playing
        if (video.paused) {
            video.play().then(() => {
                // Video is now playing
            }).catch((error) => {
                console.error("Error attempting to play the video:", error);
                // Handle the error here. For example, you can try playing the video again
                // or provide some feedback to the user.
            });
        } else {
            // If the video is playing, pause it
            video.pause();
        }
    }
    
    function toggleFullscreen(imageSrc) {
        var fullscreenDiv = document.getElementById('fullscreenDiv');
        var imgTag = fullscreenDiv.querySelector('img');

        if (!fullscreenDiv.classList.contains('active')) {
            imgTag.src = imageSrc;
            fullscreenDiv.classList.add('active');
        } else {
            fullscreenDiv.classList.remove('active');
        }
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('calendarModal');
        if (event.target === modal) {
            closeCalendar();
        }
    }
</script>
</body>
</html>